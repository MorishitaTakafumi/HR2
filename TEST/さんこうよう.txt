    Private oEd As LifePredictionDataClass


    Private Sub ShowPage()
        oEd = oLifeDataList(cIdx)
        If Not oEd.calced Then
            If oEd.analysis_kbn = LifePredictionDataClass.EN_PATTERN.mitei Then '直線則／放物線則未定時は、直線則を仮採用する
                oEd.analysis_kbn = LifePredictionDataClass.EN_PATTERN.cyokusen
            End If
            oEd.calcLife()
            If Notify IsNot Nothing Then
                Notify(cIdx, True)
            End If
        End If
        ShowData(oEd)
        lb_page.Text = (cIdx + 1).ToString & "/" & oLifeDataList.Count.ToString
    End Sub


    '今回の極値・最大・最小・平均描画
    Private Sub ddKonkai(ByVal g As Graphics)
        Dim nensu As New List(Of Double)
        Dim depth As New List(Of Double)
        oEd.MakeSaisyo2joList(nensu, depth, (oEd.analysis_kbn = LifePredictionDataClass.EN_PATTERN.cyokusen))

        Dim sx, sy As Integer
        For j As Integer = 0 To nensu.Count - 1
            If nensu(j) > 0 Then 'V1.1.1 使用年数0年はプロットしない
                sx = cnvAxisX(nensu(j))
                sy = cnvAxisY(depth(j))
                ddTen(g, sx, sy)
            End If
        Next

        Dim pen As New Drawing.Pen(Brushes.Black)
        Dim mFont As New Font("Meiryo UI", 8)

        'V1.1.1 全数検査時は"極値"表示しない
        Dim ss As String = (oEd.kosinnen + oEd.siyonensu).ToString
        If Not oEd.IsZensuKensa Then
            ss &= "極値"
        End If
        g.DrawString(ss, mFont, Brushes.Red, sx - 1.1 * g.MeasureString(ss, mFont).Width, sy - 1.1 * g.MeasureString(ss, mFont).Height)

        ss = "(使用期間：" & oEd.siyonensu.ToString & "年)"
        g.DrawString(ss, mFont, Brushes.Red, sx - 0.5 * g.MeasureString(ss, mFont).Width, GEY - 2 * g.MeasureString(ss, mFont).Height)

        Dim maxv, minv, ave As Double
        ave = oEd.GetDepthMaxMinAve(maxv, minv)
        Dim sy_max As Integer = cnvAxisY(maxv)
        ss = "最大"
        g.DrawString(ss, mFont, Brushes.Red, sx + 10, sy_max - 0.5 * g.MeasureString(ss, mFont).Height)
        g.DrawRectangle(pen, sx - 6, sy_max, 13, 3)

        sy = cnvAxisY(ave)
        ss = "平均"
        g.DrawString(ss, mFont, Brushes.Red, sx + 10, sy - 0.5 * g.MeasureString(ss, mFont).Height)
        g.DrawRectangle(pen, sx - 6, sy - 1, 13, 3)

        Dim sy_min As Integer = cnvAxisY(minv)
        ss = "最小"
        g.DrawString(ss, mFont, Brushes.Red, sx + 10, sy_min - 0.5 * g.MeasureString(ss, mFont).Height)
        g.DrawRectangle(pen, sx - 6, sy_min - 3, 13, 3)

        g.DrawLine(pen, sx, sy_max, sx, sy_min)
        pen.Dispose()
        mFont.Dispose()
    End Sub


    '寿命限界線との交点から降ろした線
    Private Sub ddCrossPointLine(ByVal g As Graphics, ByVal crosspoint_x As Double, ByVal crosspoint_y As Double)
        Dim cx, cy As Integer
        cx = cnvAxisX(crosspoint_x)
        cy = cnvAxisY(crosspoint_y)
        Dim pen2 As New Drawing.Pen(Brushes.Gray, 1)
        pen2.DashStyle = Drawing2D.DashStyle.DashDot
        g.DrawLine(pen2, cx, cy, cx, GEY)
        pen2.Dispose()
    End Sub


    '直近２点法（直線）によるグラフ描画
    Private Sub ddCyokkin2_line(ByVal g As Graphics)
        Dim x(3), y(3) As Double
        'X=0のとき
        x(0) = 0
        y(0) = oEd.calc_depth_cyokkin2_line(x(0))
        'X=グラフ右端値のとき
        x(1) = GetYokoMax()
        y(1) = oEd.calc_depth_cyokkin2_line(x(1))
        'Y=0のとき
        y(2) = 0
        x(2) = oEd.calc_nensu_cyokkin2_line(y(2))
        'Y=グラフ上端値のとき
        y(3) = GetTateMax()
        x(3) = oEd.calc_nensu_cyokkin2_line(y(3))

        'グラフ用紙から線がはみ出さないように始点と終点を決める
        Dim x0, y0, x1, y1 As Double
        '始点
        If y(0) >= 0 Then
            x0 = x(0)
            y0 = y(0)
        Else
            x0 = x(2)
            y0 = y(2)
        End If
        '終点
        If y(1) <= GetTateMax() Then
            x1 = x(1)
            y1 = y(1)
        Else
            x1 = x(3)
            y1 = y(3)
        End If
        Dim sx0, sy0, sx1, sy1 As Integer
        sx0 = cnvAxisX(x0)
        sx1 = cnvAxisX(x1)
        sy0 = cnvAxisY(y0)
        sy1 = cnvAxisY(y1)

        Dim pen As New Drawing.Pen(Brushes.Black, 2)
        g.DrawLine(pen, sx0, sy0, sx1, sy1)
        pen.Dispose()
        '寿命限界線との交点から降ろした線
        Dim crosspoint_x, crosspoint_y As Double
        crosspoint_y = oEd.init_thickness - oEd.min_thickness
        '両面損傷を考慮する
        Dim fixed_depth As Double = 0
        If oEd.GetSonsyoInfo(fixed_depth) <> 2 Then
            crosspoint_y -= fixed_depth
        End If
        crosspoint_x = oEd.calc_nensu_cyokkin2_line(crosspoint_y)
        ddCrossPointLine(g, crosspoint_x, crosspoint_y)
        '線の式
        If y(1) >= GetTateMax() Then 'グラフ右端の点がグラフ上端を超えている場合
            Dim tmp_x, tmp_y As Double
            tmp_y = GetTateMax() * 0.9
            tmp_x = oEd.calc_nensu_cyokkin2_line(tmp_y)
            sx1 = cnvAxisX(tmp_x)
            sy1 = cnvAxisY(tmp_y)
        End If
        ddSiki(g, oEd.siki_cyokkin2(), sx1, sy1)
    End Sub


    '最小二乗法（直線）によるグラフ描画
    Private Sub ddSaisyo2jo_line(ByVal g As Graphics, ByVal after_slide As Boolean)
        Dim x(3), y(3) As Double
        'X=0のとき
        x(0) = 0
        y(0) = oEd.calc_depth_saisyo2jo_line(x(0), after_slide)
        'X=グラフ右端値のとき
        x(1) = GetYokoMax()
        y(1) = oEd.calc_depth_saisyo2jo_line(x(1), after_slide)
        'Y=0のとき
        y(2) = 0
        x(2) = oEd.calc_nensu_saisyo2jo_line(y(2), after_slide)
        'Y=グラフ上端値のとき
        y(3) = GetTateMax()
        x(3) = oEd.calc_nensu_saisyo2jo_line(y(3), after_slide)

        'グラフ用紙から線がはみ出さないように始点と終点を決める
        Dim x0, y0, x1, y1 As Double
        '始点
        If y(0) >= 0 Then
            x0 = x(0)
            y0 = y(0)
        Else
            x0 = x(2)
            y0 = y(2)
        End If
        '終点
        If y(1) <= GetTateMax() Then
            x1 = x(1)
            y1 = y(1)
        Else
            x1 = x(3)
            y1 = y(3)
        End If
        Dim sx0, sy0, sx1, sy1 As Integer
        sx0 = cnvAxisX(x0)
        sx1 = cnvAxisX(x1)
        sy0 = cnvAxisY(y0)
        sy1 = cnvAxisY(y1)

        Dim pen As Drawing.Pen
        pen = New Drawing.Pen(Brushes.Green, 2)
        If after_slide Then
            g.DrawLine(pen, sx0, sy0, sx1, sy1)
        Else
            pen.DashStyle = Drawing2D.DashStyle.Dot
            g.DrawLine(pen, sx0, sy0, sx1, sy1)
        End If
        pen.Dispose()
        '寿命限界線との交点から降ろした線
        Dim crosspoint_x, crosspoint_y As Double
        crosspoint_y = oEd.init_thickness - oEd.min_thickness
        '両面損傷を考慮する
        Dim fixed_depth As Double = 0
        If oEd.GetSonsyoInfo(fixed_depth) <> 2 Then
            crosspoint_y -= fixed_depth
        End If
        crosspoint_x = oEd.calc_nensu_saisyo2jo_line(crosspoint_y, after_slide)
        ddCrossPointLine(g, crosspoint_x, crosspoint_y)
        '線の式
        Dim siki As String = oEd.siki_saisyo2jo(after_slide)
        If Not chkAllLine.Checked Then
            If y(1) >= GetTateMax() Then 'グラフ右端の点がグラフ上端を超えている場合
                Dim tmp_x, tmp_y As Double
                tmp_y = GetTateMax() * 0.9
                tmp_x = oEd.calc_nensu_saisyo2jo_line(tmp_y, after_slide)
                sx1 = cnvAxisX(tmp_x)
                sy1 = cnvAxisY(tmp_y)
            End If
            ddSiki(g, siki, sx1, sy1)
        Else
            Dim tmp_x, tmp_y, tmp_y2 As Double
            tmp_x = 0.5 * (x0 + x1)
            tmp_y = oEd.calc_depth_saisyo2jo_line(tmp_x, after_slide)
            tmp_y2 = oEd.calc_depth_saisyo2jo_line(tmp_x, Not after_slide)
            sx1 = cnvAxisX(tmp_x)
            sy1 = cnvAxisY(tmp_y)
            ddSiki(g, siki, sx1, sy1, (tmp_y >= tmp_y2))
        End If
    End Sub


Public Class AnaForm

    Private Const HIS_CNT As Integer = 4

    Private oShortRaceName As New ShortRaceNameClass
    Private anaList As New raceAnaListClass
    Private cRaceHeader As RaceHeaderClass
    Private spanScore As New List(Of Integer)
    Private cyakujun As New List(Of Integer)
    Private agarisa1 As New List(Of Single)
    Private agarisa2 As New List(Of Single)
    Private agarisa3 As New List(Of Single)
    Private agarisa4 As New List(Of Single)
    Private cyakusa1 As New List(Of Single)
    Private cyakusa2 As New List(Of Single)
    Private cyakusa3 As New List(Of Single)
    Private cyakusa4 As New List(Of Single)

    Public Sub autoRun(ByVal syutubaFileName As String)
        autoMode = True
        txtURL.Text = ""
        RbFile.Checked = True
        txtFile.Text = syutubaFileName
        Show()
        BtnGo.PerformClick()
        BtnHistGet.PerformClick()
        autoModeResult = ""
        Dim cnt As Integer = 0
        Dim jrow As Integer = flx.Rows.Fixed
        Dim flg(3) As Integer
        While jrow < flx.Rows.Count
            If (cnt > 4 AndAlso flx.Item(jrow, FlxCol.dof_total).ToString <> flx.Item(jrow - 1, FlxCol.dof_total).ToString) Then
                Exit While
            End If
            autoModeResult &= flx.Item(jrow, FlxCol.chk).ToString & "," & flx.Item(jrow, FlxCol.ninki).ToString & "," & flx.Item(jrow, FlxCol.dof_total).ToString & vbLf
            If IsNumeric(flx.Item(jrow, FlxCol.chk)) Then
                Dim cyakujun As Integer = flx.Item(jrow, FlxCol.chk)
                If cyakujun >= 1 AndAlso cyakujun <= 3 Then
                    flg(cyakujun) = 1
                End If
            End If
            cnt += 1
            jrow += 1
        End While
        If flg(1) <> 1 OrElse flg(2) <> 1 OrElse flg(3) <> 1 Then
            autoModeResult &= "*" & vbLf
            jrow = flx.Rows.Fixed
            While jrow < flx.Rows.Count
                If IsNumeric(flx.Item(jrow, FlxCol.chk)) Then
                    Dim cyakujun As Integer = flx.Item(jrow, FlxCol.chk)
                    If cyakujun >= 1 AndAlso cyakujun <= 3 AndAlso flg(cyakujun) <> 1 Then
                        autoModeResult &= flx.Item(jrow, FlxCol.chk).ToString & "," & flx.Item(jrow, FlxCol.ninki).ToString & "," & flx.Item(jrow, FlxCol.dof_total).ToString & vbLf
                    End If
                End If
                jrow += 1
            End While
        End If
    End Sub


    Private Sub ShowTable(ByVal sblist As raceAnaListClass)
        SetUpFlx()
        Dim xx(FlxCol.cols - 1) As String
        For j As Integer = 0 To sblist.cnt - 1
            Dim oUma As raceAnanClass = sblist.GetBodyRef(j)

            If oUma.waku > 0 Then
                xx(FlxCol.waku) = oUma.waku
                If oUma.umaban > 0 Then
                    xx(FlxCol.umaban) = oUma.umaban
                Else
                    xx(FlxCol.umaban) = "取消"
                End If
                If oUma.ninki > 0 Then
                    xx(FlxCol.ninki) = oUma.ninki.ToString("D2")
                Else
                    xx(FlxCol.ninki) = ""
                End If
                xx(FlxCol.hutan) = oUma.hutan
            Else
                xx(FlxCol.waku) = ""
                xx(FlxCol.umaban) = ""
                xx(FlxCol.ninki) = ""
            End If
            xx(FlxCol.bamei) = oUma.bamei
            If xx(FlxCol.umaban) = "取消" Then
                xx(FlxCol.spanVal) = ""
                For i As Integer = FlxCol.histStart To FlxCol.cols - 1
                    xx(i) = ""
                Next
            Else
                xx(FlxCol.spanVal) = AnaValClass.Score2String(oUma.spanScore) 'oUma.spanVal
                For i As Integer = 0 To HIS_CNT - 1
                    xx(FlxCol.histStart + i) = oUma.hist(i)
                Next
                xx(FlxCol.kyoriScore) = AnaValClass.Score2String(oUma.kyoriScore)
                xx(FlxCol.dateScore) = AnaValClass.Score2String(oUma.dateScore)
                xx(FlxCol.agarisaRank) = oUma.agarisaRank
                xx(FlxCol.cyakusaRank) = oUma.cyakusaRank
                xx(FlxCol.timeRank) = oUma.cyakusaRank + oUma.agarisaRank
                xx(FlxCol.test_point) = oUma.extraPoint
            End If
            flx.AddItem(xx)
        Next
        flx.AutoSizeCols()
        flx.AutoSizeRows()
    End Sub


    '解析実行
    Private Sub BtnGo_Click(sender As Object, e As EventArgs) Handles BtnGo.Click
        If oParam.remarks = "" Then
            MsgBox("パラメータを選択してください！", MsgBoxStyle.Critical, Me.Text)
            Return
        End If

        If Not autoMode Then
            ClearWebPageAccessCounter()
        End If
        Dim form3argStr As String = ""
        If RbURL.Checked Then
            form3argStr = txtURL.Text.Trim
        ElseIf RbFile.Checked Then
            form3argStr = txtFile.Text.Trim
        End If

        If form3argStr.Length = 0 Then
            Return
        End If

        Dim fm3 As New Form3 '出走馬
        If RbURL.Checked Then
            fm3.entry(form3argStr)
        ElseIf RbFile.Checked Then
            fm3.entry2(form3argStr)
        End If
        Dim kekka As New KekkaListClass
        Dim umaHists As New umaHistListClass
        Dim oUmaHeader As UmaHeaderClass

        ListBox1.Items.Clear()
        cRaceHeader = fm3.oRaceHeader
        CbGradeL.SelectedIndex = cRaceHeader.GetClassCode
        CbGradeH.SelectedIndex = CbGradeL.SelectedIndex

        ListBox1.Items.Add("競馬場：" & cRaceHeader.keibajo)
        ListBox1.Items.Add("開催日：" & cRaceHeader.dt.ToString("yyyy年MM月dd日"))

        ListBox1.Items.Add("レース名：" & cRaceHeader.race_name)
        ListBox1.Items.Add("グレード：" & cRaceHeader.grade)

        ListBox1.Items.Add("距離：" & cRaceHeader.kyori.ToString)
        ListBox1.Items.Add("種別：" & cRaceHeader.syubetu)
        ListBox1.Items.Add("クラス：" & cRaceHeader.class_name)
        cRaceHeader.class_code = cRaceHeader.GetClassCode()
        anaList.init()
        txtJo.Text = cRaceHeader.keibajo
        Dim errmsg As String = ""
        Using con As New SQLiteConnection(GetDbConnectionString)
            Dim cmd As SQLiteCommand = con.CreateCommand
            Try
                con.Open()
                errmsg = oShortRaceName.load(cmd)
                If errmsg.Length > 0 Then
                    Exit Try
                End If
                For j As Integer = 0 To fm3.syutubaList.cnt - 1
                    lb_msg.Text = (j + 1).ToString & "/" & (fm3.syutubaList.cnt).ToString
                    Dim rA As New raceAnanClass
                    Dim o As SyutubaClass = fm3.syutubaList.GetBodyRef(j)
                    rA.waku = o.waku
                    rA.umaban = o.umaban
                    rA.bamei = o.bamei
                    rA.ninki = o.ninki
                    rA.hutan = o.hutan

                    Dim umaHistList As umaHistListClass = UmaStore.GetData(o.bamei)
                    If umaHistList Is Nothing Then
                        umaHists.init()
                        errmsg = umaHists.GetUmaInfo(cmd, makeJRAurl(o.href), o.bamei, cRaceHeader.dt, True)
                        If errmsg.Length > 0 Then
                            Exit Try
                        End If
                        umaHistList = umaHists
                        UmaStore.add1(umaHists.Clone)
                    End If
                    oUmaHeader = umaHistList.umaHeader
                    rA.spanScore = umaHistList.GetSpanScore(cRaceHeader.dt, rA.spanVal)
                    rA.dateScore = umaHistList.GetSameDateSameKyoriScore(cRaceHeader.dt, cRaceHeader.kyori, cRaceHeader.syubetu, rA.kyoriScore)
                    rA.extraPoint = umaHistList.GetExtraPoint()
                    For i As Integer = 0 To umaHistList.cnt - 1
                        If i = HIS_CNT Then
                            Exit For
                        End If

                        lb_msg.Text = (j + 1).ToString & "/" & (fm3.syutubaList.cnt).ToString & " | " & (i + 1).ToString & "/6"
                        Me.Refresh()

                        Dim oS As UmaHistClass = umaHistList.GetBodyRef(i)
                        Dim shortname As String = oS.racename
                        oS.racename = oShortRaceName.GetLongName(oS.racename)
                        oS.bamei = o.bamei
                        Dim kekkaList As KekkaListClass = kekkaStore.GetData(oS)
                        Dim oRaceHead As RaceHeaderClass
                        If kekkaList Is Nothing Then
                            kekka.init()
                            oRaceHead = kekka.raceHeader
                            errmsg = oRaceHead.loadByUmaHist(cmd, oS)
                            If errmsg.Length > 0 Then
                                Exit Try
                            End If
                            If oRaceHead.id < 0 Then
                                Dim existFlag As Boolean
                                errmsg = kekka.GetRaceKekka(cmd, makeJRAurl(oS.href), existFlag, oS.dt.ToString("yyyy/MM/dd"), oS.racename, oS.jo_code, oS.type_code, oS.distance, oS.bamei, True)
                                If errmsg.Length > 0 Then
                                    Exit Try
                                End If
                                If oRaceHead.race_name.Trim.Length > 0 Then
                                    If shortname <> oRaceHead.race_name Then
                                        errmsg = oShortRaceName.addNew(cmd, shortname, oRaceHead.race_name)
                                        If errmsg.Length > 0 Then
                                            Exit Try
                                        End If
                                    End If
                                End If
                            End If

                            If oRaceHead.id > 0 AndAlso kekka.cnt = 0 Then
                                errmsg = kekka.load(cmd, oRaceHead.id)
                                If errmsg.Length > 0 Then
                                    Exit Try
                                End If
                            End If

                            If oRaceHead.id > 0 Then
                                kekkaList = kekka
                                kekkaStore.add1(kekka.Clone())
                            End If
                        Else
                            oRaceHead = kekkaList.raceHeader
                        End If

                        If oRaceHead.race_name.Trim.Length > 0 Then
                            kekkaList.correctCyakusa(oRaceHead)
                            kekkaList.setAgarisa(oRaceHead)
                        End If

                        If oRaceHead.id > 0 AndAlso kekkaList.cnt > 0 Then
                            rA.hist(i) = kekkaList.GetAgarisa(o.bamei, cRaceHeader.syubetu)
                        End If
                    Next
                    rA.SetTimeRank(oParam)
                    anaList.add1(rA)
                Next
            Catch ex As Exception
                errmsg = ex.Message
            End Try
        End Using
        If errmsg.Length > 0 Then
            MsgBox(errmsg, MsgBoxStyle.Critical, Me.Text)
        End If
        ShowTable(anaList)
        PaintTable(anaList)
        fm3.Close()
        ShowCyakujun()
        AutoSetSearchParams()
        If Not autoMode Then
            showWebPageAccessCounter()
        End If
    End Sub

    'Fileから入った時は結果が分かるので取得して表示する
    Private Sub ShowCyakujun()
        Dim errmsg As String = ""
        Using conn As New SQLiteConnection(GetDbConnectionString)
            Dim cmd As SQLite.SQLiteCommand = conn.CreateCommand
            conn.Open()
            Try
                cmd.CommandText = "SELECT A.cyakujun, A.bamei FROM RaceHeader R INNER JOIN Kekka A ON R.id=A.race_header_id 
                                    WHERE R.dt=@dt AND R.race_name=@race_name"
                cmd.Parameters.AddWithValue("@dt", cRaceHeader.dt)
                cmd.Parameters.AddWithValue("@race_name", cRaceHeader.race_name)
                Dim r As SQLite.SQLiteDataReader = cmd.ExecuteReader
                While r.Read
                    Dim bamei As String = CStr(r("bamei"))
                    Dim cyakujun As Integer = CInt(r("cyakujun"))
                    For jrow As Integer = flx.Rows.Fixed To flx.Rows.Count - 1
                        If flx.Item(jrow, FlxCol.bamei) = bamei Then
                            flx.Item(jrow, FlxCol.chk) = cyakujun.ToString("D2")
                            Exit For
                        End If
                    Next
                End While
                r.Close()
            Catch ex As Exception
                errmsg = ex.Message
            End Try
        End Using
        If errmsg.Length > 0 Then
            MsgBox(errmsg, MsgBoxStyle.Critical, Me.Text)
        End If
    End Sub

    '該当件数取得
    Private Function GetRaceCount(ByRef raceCount As Integer) As String
        raceCount = 0
        Using conn As New SQLiteConnection(GetDbConnectionString)
            Dim cmd As SQLite.SQLiteCommand = conn.CreateCommand
            Try
                conn.Open()
                cmd.CommandText = "SELECT R.dt FROM RaceHeader R INNER JOIN Kekka A ON R.id=A.race_header_id WHERE R.dt<@dt"
                cmd.Parameters.AddWithValue("@dt", cRaceHeader.dt)
                Dim sql As String = ""
                If txtJo.Text.Trim.Length > 0 Then
                    Dim ss As String = SelectJoForm.JoText2JoCode(txtJo.Text.Trim)
                    sql &= " AND R.jo_code IN (" & ss & ")"
                End If
                If chkKyori.Checked Then
                    sql &= " AND R.kyori=@kyori AND R.type_code=@type_code"
                    cmd.Parameters.AddWithValue("@kyori", cRaceHeader.kyori)
                    cmd.Parameters.AddWithValue("@type_code", cRaceHeader.type_code)
                End If
                If chkRacename.Checked Then
                    sql &= " AND R.race_name=@race_name"
                    cmd.Parameters.AddWithValue("@race_name", cRaceHeader.race_name)
                ElseIf chkRacename2.Checked Then
                    sql &= " AND R.race_name like @race_name"
                    cmd.Parameters.AddWithValue("@race_name", "%" & txtRacename.Text & "%")
                End If
                If CbGradeL.SelectedIndex >= 0 Then
                    sql &= " AND R.class_code>=@class_code_lo"
                    cmd.Parameters.AddWithValue("@class_code_lo", CbGradeL.SelectedIndex)
                End If
                If CbGradeH.SelectedIndex >= 0 Then
                    sql &= " AND R.class_code<=@class_code_hi"
                    cmd.Parameters.AddWithValue("@class_code_hi", CbGradeH.SelectedIndex)
                End If
                If CbCyakujun.SelectedIndex >= 1 AndAlso CbCyakujun.SelectedIndex <= 3 Then
                    sql &= " AND A.cyakujun<=@cyakujun AND A.cyakujun>0"
                    cmd.Parameters.AddWithValue("@cyakujun", CbCyakujun.SelectedIndex)
                ElseIf CbCyakujun.SelectedIndex = 4 Then
                    sql &= " AND A.cyakujun>3 AND A.cyakujun<=20 "
                Else
                    sql &= " AND A.cyakujun>0 AND A.cyakujun<=20 "
                End If
                If sql.Length > 0 Then
                    cmd.CommandText &= sql
                End If

                Dim r As SQLite.SQLiteDataReader = cmd.ExecuteReader
                Dim dt As Date
                Dim lstTuki As New List(Of Integer)
                If txtTuki.Text.Trim.Length > 0 Then
                    Dim sbf() As String = Split(txtTuki.Text.Trim, ",")
                    For Each txt As String In sbf
                        If IsNumeric(txt) AndAlso CInt(txt) >= 1 AndAlso CInt(txt) <= 12 Then
                            lstTuki.Add(CInt(txt))
                        End If
                    Next
                End If
                While r.Read
                    dt = CDate(r("dt"))
                    If lstTuki.Count = 0 OrElse lstTuki.Contains(dt.Month) Then
                        raceCount += 1
                    End If
                End While
                r.Close()
                Return ""
            Catch ex As Exception
                Return ex.Message
            End Try
        End Using
    End Function

    '過去レース解析値の検索条件を自動セット
    Private Sub AutoSetSearchParams()
        Dim ok_cnt As Integer = 8
        'デフォルト条件
        Dim cnt As Integer
        Dim errmsg As String = GetRaceCount(cnt)
        lb_msg.Text = cnt.ToString
        If errmsg.Length > 0 Then
            MsgBox(errmsg, MsgBoxStyle.Critical, Me.Text)
            Return
        End If
        If cnt >= ok_cnt Then
            Return
        End If
        '競馬場を空にしてみる
        Dim tmpStr As String = txtJo.Text
        txtJo.Text = ""
        errmsg = GetRaceCount(cnt)
        lb_msg.Text = cnt.ToString
        If errmsg.Length > 0 Then
            MsgBox(errmsg, MsgBoxStyle.Critical, Me.Text)
            Return
        End If
        If cnt >= ok_cnt Then
            Return
        End If
        '競馬場を元に戻して同一レース名を外して同一月で
        txtJo.Text = tmpStr
        chkRacename.Checked = False
        txtTuki.Text = cRaceHeader.dt.Month.ToString
        errmsg = GetRaceCount(cnt)
        lb_msg.Text = cnt.ToString
        If errmsg.Length > 0 Then
            MsgBox(errmsg, MsgBoxStyle.Critical, Me.Text)
            Return
        End If
        If cnt >= ok_cnt Then
            Return
        End If
        '前後月を含めて
        Dim tuki As Integer = cRaceHeader.dt.Month
        If tuki = 1 Then
            txtTuki.Text = "1,2,12"
        ElseIf tuki = 12 Then
            txtTuki.Text = "11,12,1"
        Else
            txtTuki.Text = (tuki - 1).ToString & "," & tuki.ToString & "," & (tuki + 1).ToString
        End If
        errmsg = GetRaceCount(cnt)
        lb_msg.Text = cnt.ToString
        If errmsg.Length > 0 Then
            MsgBox(errmsg, MsgBoxStyle.Critical, Me.Text)
            Return
        End If
        If cnt >= ok_cnt Then
            Return
        End If
        '全月
        txtTuki.Text = ""
        errmsg = GetRaceCount(cnt)
        lb_msg.Text = cnt.ToString
        If errmsg.Length > 0 Then
            MsgBox(errmsg, MsgBoxStyle.Critical, Me.Text)
            Return
        End If
    End Sub

    Private Sub new_logic()
        spanScore.Clear()
        cyakujun.Clear()
        agarisa1.Clear()
        agarisa2.Clear()
        agarisa3.Clear()
        agarisa4.Clear()
        cyakusa1.Clear()
        cyakusa2.Clear()
        cyakusa3.Clear()
        cyakusa4.Clear()

        Dim errmsg As String = ""
        Using conn As New SQLiteConnection(GetDbConnectionString)
            Dim cmd As SQLite.SQLiteCommand = conn.CreateCommand
            Try
                conn.Open()
                errmsg = oShortRaceName.load(cmd)
                If errmsg.Length > 0 Then
                    Exit Try
                End If

                cmd.CommandText = "SELECT R.dt, A.cyakujun, A.bamei FROM RaceHeader R INNER JOIN Kekka A ON R.id=A.race_header_id WHERE R.dt<@dt"
                cmd.Parameters.AddWithValue("@dt", cRaceHeader.dt)
                Dim sql As String = ""
                If txtJo.Text.Trim.Length > 0 Then
                    Dim ss As String = SelectJoForm.JoText2JoCode(txtJo.Text.Trim)
                    sql &= " AND R.jo_code IN (" & ss & ")"
                End If
                If chkKyori.Checked Then
                    sql &= " AND R.kyori=@kyori AND R.type_code=@type_code"
                    cmd.Parameters.AddWithValue("@kyori", cRaceHeader.kyori)
                    cmd.Parameters.AddWithValue("@type_code", cRaceHeader.type_code)
                End If
                If chkRacename.Checked Then
                    sql &= " AND R.race_name=@race_name"
                    cmd.Parameters.AddWithValue("@race_name", cRaceHeader.race_name)
                ElseIf chkRacename2.Checked Then
                    sql &= " AND R.race_name like @race_name"
                    cmd.Parameters.AddWithValue("@race_name", "%" & txtRacename.Text & "%")
                End If
                If CbGradeL.SelectedIndex >= 0 Then
                    sql &= " AND R.class_code>=@class_code_lo"
                    cmd.Parameters.AddWithValue("@class_code_lo", CbGradeL.SelectedIndex)
                End If
                If CbGradeH.SelectedIndex >= 0 Then
                    sql &= " AND R.class_code<=@class_code_hi"
                    cmd.Parameters.AddWithValue("@class_code_hi", CbGradeH.SelectedIndex)
                End If
                If CbCyakujun.SelectedIndex >= 1 AndAlso CbCyakujun.SelectedIndex <= 3 Then
                    sql &= " AND A.cyakujun<=@cyakujun AND A.cyakujun>0"
                    cmd.Parameters.AddWithValue("@cyakujun", CbCyakujun.SelectedIndex)
                ElseIf CbCyakujun.SelectedIndex = 4 Then
                    sql &= " AND A.cyakujun>3 AND A.cyakujun<=20 "
                Else
                    sql &= " AND A.cyakujun>0 AND A.cyakujun<=20 "
                End If
                If sql.Length > 0 Then
                    cmd.CommandText &= sql
                End If
                cmd.CommandText &= " ORDER BY R.dt DESC"

                Dim r As SQLite.SQLiteDataReader = cmd.ExecuteReader
                Dim bameiList As New List(Of String)
                Dim cyakujunList As New List(Of Integer)
                Dim dtList As New List(Of Date)

                Dim dt As Date
                Dim lstTuki As New List(Of Integer)
                If txtTuki.Text.Trim.Length > 0 Then
                    Dim sbf() As String = Split(txtTuki.Text.Trim, ",")
                    For Each txt As String In sbf
                        If IsNumeric(txt) AndAlso CInt(txt) >= 1 AndAlso CInt(txt) <= 12 Then
                            lstTuki.Add(CInt(txt))
                        End If
                    Next
                End If

                While r.Read
                    dt = CDate(r("dt"))
                    If lstTuki.Count = 0 OrElse lstTuki.Contains(dt.Month) Then
                        bameiList.Add(r("bamei"))
                        cyakujunList.Add(r("cyakujun"))
                        dtList.Add(dt)
                        If bameiList.Count >= 20 Then 'たくさん見てもあまり結果は変わらない
                            Exit While
                        End If
                    End If
                End While
                r.Close()
                For j As Integer = 0 To bameiList.Count - 1
                    If (j Mod 10) = 0 Then
                        lb_msg.Text = j.ToString & "/" & bameiList.Count.ToString
                        lb_msg.Refresh()
                    End If
                    errmsg = GetAgarisaCyakusa(cmd, bameiList(j), cyakujunList(j), dtList(j))
                    If errmsg.Length > 0 Then
                        Exit For
                    End If
                Next
            Catch ex As Exception
                errmsg = ex.Message
            End Try
        End Using
        If errmsg.Length > 0 Then
            MsgBox(errmsg, MsgBoxStyle.Critical, Me.Text)
        End If
    End Sub

    Private Sub old_logic()
        spanScore.Clear()
        cyakujun.Clear()
        agarisa1.Clear()
        agarisa2.Clear()
        agarisa3.Clear()
        agarisa4.Clear()
        cyakusa1.Clear()
        cyakusa2.Clear()
        cyakusa3.Clear()
        cyakusa4.Clear()

        Using conn As New SQLiteConnection(GetDbConnectionString)
            Dim errmsg As String = ""

            Dim cmd As SQLite.SQLiteCommand = conn.CreateCommand
            conn.Open()
            Try
                cmd.CommandText = "SELECT A.* FROM RaceHeader R INNER JOIN AnaVal A ON R.id=A.rhead_id WHERE R.dt<@dt"
                cmd.Parameters.AddWithValue("@dt", cRaceHeader.dt)
                Dim sql As String = ""
                If txtJo.Text.Trim.Length > 0 Then
                    Dim ss As String = SelectJoForm.JoText2JoCode(txtJo.Text.Trim)
                    sql &= " AND R.jo_code IN (" & ss & ")"
                End If
                If chkKyori.Checked Then
                    sql &= " AND R.kyori=@kyori AND R.type_code=@type_code"
                    cmd.Parameters.AddWithValue("@kyori", cRaceHeader.kyori)
                    cmd.Parameters.AddWithValue("@type_code", cRaceHeader.type_code)
                End If
                If chkRacename.Checked Then
                    sql &= " AND R.race_name=@race_name"
                    cmd.Parameters.AddWithValue("@race_name", cRaceHeader.race_name)
                ElseIf chkRacename2.Checked Then
                    sql &= " AND R.race_name like @race_name"
                    cmd.Parameters.AddWithValue("@race_name", "%" & txtRacename.Text & "%")
                End If
                'If chkGrade.Checked Then
                '    sql &= " AND R.class_code=@class_code"
                '    cmd.Parameters.AddWithValue("@class_code", cRaceHeader.class_code)
                'End If
                If CbCyakujun.SelectedIndex >= 1 AndAlso CbCyakujun.SelectedIndex <= 3 Then
                    sql &= " AND A.cyakujun<=@cyakujun AND A.cyakujun>0"
                    cmd.Parameters.AddWithValue("@cyakujun", CbCyakujun.SelectedIndex)
                ElseIf CbCyakujun.SelectedIndex = 4 Then
                    sql &= " AND A.cyakujun>3 AND A.cyakujun<=20 "
                Else
                    sql &= " AND A.cyakujun>0 AND A.cyakujun<=20 "
                End If
                If sql.Length > 0 Then
                    cmd.CommandText &= sql
                End If
                Dim r As SQLite.SQLiteDataReader = cmd.ExecuteReader
                While r.Read
                    cyakujun.Add(r("cyakujun"))
                    spanScore.Add(r("spanScore"))
                    agarisa1.Add(r("agarisa1"))
                    agarisa2.Add(r("agarisa2"))
                    agarisa3.Add(r("agarisa3"))
                    agarisa4.Add(r("agarisa4"))
                    cyakusa1.Add(r("cyakusa1"))
                    cyakusa2.Add(r("cyakusa2"))
                    cyakusa3.Add(r("cyakusa3"))
                    cyakusa4.Add(r("cyakusa4"))
                End While
                r.Close()
            Catch ex As Exception
                errmsg = ex.Message
            End Try

            If errmsg.Length > 0 Then
                MsgBox(errmsg, MsgBoxStyle.Critical, Me.Text)
            End If
        End Using
    End Sub

    '馬名を指定して直近４走の上り差と着差をagarisa1-4, cyakusa1-4にセットする
    '
    Private Function GetAgarisaCyakusa(ByVal cmd As SQLiteCommand,
                                       ByVal arg_bamei As String, ByVal arg_cyakujun As Integer, ByVal dt_max As Date) As String

        Dim errmsg As String = ""
        Dim oUmaHist As umaHistListClass = UmaStore.GetData(arg_bamei)
        If oUmaHist Is Nothing Then
            Dim oUmaHeader As New UmaHeaderClass
            Try
                errmsg = oUmaHeader.load(cmd, arg_bamei)
                If errmsg.Length = 0 AndAlso oUmaHeader.rec_id > 0 Then
                    Dim UmaHists As New umaHistListClass
                    errmsg = UmaHists.load(cmd, oUmaHeader.rec_id, dt_max)
                    If errmsg.Length > 0 Then
                        Return errmsg
                    End If
                    oUmaHist = UmaHists
                Else
                    Return ""
                End If
            Catch ex As Exception
                Return "GetAgarisaCyakusa() " & ex.Message
            End Try
        End If


        Try
            Dim kekka As New KekkaListClass
            Dim rA As New raceAnanClass
            rA.spanScore = oUmaHist.GetSpanScore(dt_max, rA.spanVal)
            Dim agarisa(3) As Single
            Dim cyakusa(3) As Single
            For j As Integer = 0 To 3 '適合度計算で無効となる値を初期値とする
                agarisa(j) = DMY_VAL
                cyakusa(j) = DMY_VAL
            Next
            Dim cnt As Integer = 0
            For j As Integer = 0 To oUmaHist.cnt - 1
                Dim oS As UmaHistClass = oUmaHist.GetBodyRef(j)
                If DateDiff(DateInterval.Day, oS.dt, cRaceHeader.dt) > 1 AndAlso oS.href.Trim.Length > 0 Then
                    Dim shortname As String = oS.racename
                    oS.racename = oShortRaceName.GetLongName(oS.racename)
                    Dim kekkaList As KekkaListClass = kekkaStore.GetData(oS)
                    Dim oRaceHead As RaceHeaderClass
                    If kekkaList Is Nothing Then
                        kekka.init()
                        oRaceHead = kekka.raceHeader
                        errmsg = oRaceHead.loadByUmaHist(cmd, oS)
                        If errmsg.Length > 0 Then
                            Return errmsg
                        End If
                        If oRaceHead.id < 0 Then
                            Dim contents As String = GetWebPageText(makeJRAurl(oS.href))
                            GetKekka(contents, kekka)
                            oRaceHead.keibajo = GetWhenWhere(contents, oRaceHead.dt)
                            oRaceHead.jo_code = GetKeibajoCode(oRaceHead.keibajo)
                            oRaceHead.race_no = GetRaceNo(contents)
                            oRaceHead.race_name = GetRaceName(contents, oRaceHead.grade)
                            oRaceHead.class_name = GetClassCource(contents, oRaceHead.kyori, oRaceHead.syubetu)
                            oRaceHead.class_code = oRaceHead.GetClassCode()
                            oRaceHead.tosu = kekka.cnt
                            If oRaceHead.race_name.Trim.Length > 0 Then
                                If shortname <> oRaceHead.race_name Then
                                    errmsg = oShortRaceName.addNew(cmd, shortname, oRaceHead.race_name)
                                    If errmsg.Length > 0 Then
                                        Return errmsg
                                    End If
                                End If
                            End If
                            oS.racename = oRaceHead.race_name
                            If oS.jo_code < 0 Then
                                oS.jo_code = oRaceHead.jo_code
                            End If
                            oS.bamei = arg_bamei
                            oRaceHead.push()
                            errmsg = oRaceHead.loadByUmaHist(cmd, oS)
                            If errmsg.Length > 0 Then
                                Return errmsg
                            ElseIf oRaceHead.id < 0 Then
                                oRaceHead.pop()
                            End If
                        End If
                        If oRaceHead.race_name.Trim.Length > 0 Then
                            If oRaceHead.id < 0 Then
                                kekka.setCyakusa()
                                errmsg = SaveRaceKekka(cmd, kekka)
                                If errmsg.Length > 0 Then
                                    Return errmsg
                                End If
                            Else
                                errmsg = kekka.load(cmd, oRaceHead.id)
                                If errmsg.Length > 0 Then
                                    Return errmsg
                                End If
                            End If
                            kekkaStore.add1(kekka.Clone())
                            kekkaList = kekka
                        End If
                    Else
                        oRaceHead = kekkaList.raceHeader
                    End If

                    If oRaceHead.race_name.Trim.Length > 0 Then
                        kekkaList.correctCyakusa(oRaceHead)
                        kekkaList.setAgarisa(oRaceHead)
                        Dim oK As KekkaClass = kekkaList.GetBodyRefByBamei(arg_bamei)
                        If oK IsNot Nothing Then
                            If oRaceHead.type_code = cRaceHeader.type_code Then '異種レースは対象外とする
                                agarisa(cnt) = oK.agarisa
                                cyakusa(cnt) = oK.cyakusa_cr
                            End If
                            cnt += 1
                            If cnt > 3 Then
                                Exit For
                            End If
                        End If
                    End If
                End If
            Next
            cyakujun.Add(arg_cyakujun)
            spanScore.Add(rA.spanScore)
            agarisa1.Add(agarisa(0))
            agarisa2.Add(agarisa(1))
            agarisa3.Add(agarisa(2))
            agarisa4.Add(agarisa(3))
            cyakusa1.Add(cyakusa(0))
            cyakusa2.Add(cyakusa(1))
            cyakusa3.Add(cyakusa(2))
            cyakusa4.Add(cyakusa(3))
            Return ""
        Catch ex As Exception
            Return "GetAgarisaCyakusa() " & ex.Message
        End Try
    End Function

    Private Sub BtnDof_Click(sender As Object, e As EventArgs) Handles BtnDof.Click
        If spanScore.Count > 0 Then
            Dim cmp_cyakujun As Integer = 1
            If CbCyakujun2.SelectedIndex >= 0 Then
                cmp_cyakujun = CbCyakujun2.SelectedIndex + 1
            End If

            For jrow As Integer = flx.Rows.Fixed To flx.Rows.Count - 1
                If flx.Item(jrow, FlxCol.spanVal) IsNot Nothing Then
                    Dim myScore As Integer = cnvScoreStr2Val(flx.Item(jrow, FlxCol.spanVal))
                    Dim coefSpan As Double = GetSpanScoreCoefficient(myScore)
                    flx.Item(jrow, FlxCol.coef_span) = coefSpan.ToString("F2")
                    myScore = cnvScoreStr2Val(flx.Item(jrow, FlxCol.dateScore))
                    Dim coefDate As Double = GetDateScoreCoefficient(myScore)
                    flx.Item(jrow, FlxCol.coef_date) = coefDate.ToString("F2")
                    Dim agarisaPoint, cyakusaPoint As Integer
                    agarisaPoint = GetDofTime(jrow, cmp_cyakujun, cyakusaPoint)
                    flx.Item(jrow, FlxCol.dof_agarisa) = agarisaPoint
                    flx.Item(jrow, FlxCol.dof_cyakusa) = cyakusaPoint
                    Dim dof_total As Integer = Int(coefSpan * coefDate * (agarisaPoint + cyakusaPoint))
                    flx.Item(jrow, FlxCol.dof_total) = dof_total
                    If IsNumeric(flx.Item(jrow, FlxCol.test_point)) Then
                        Dim test_point As Integer = CInt(flx.Item(jrow, FlxCol.test_point))
                        dof_total += test_point
                    End If

                    If IsNumeric(flx.Item(jrow, FlxCol.timeRank)) Then
                        flx.Item(jrow, FlxCol.g_total) = dof_total + CInt(flx.Item(jrow, FlxCol.timeRank))
                    Else
                        flx.Item(jrow, FlxCol.g_total) = dof_total
                    End If
                End If
            Next
        Else
            MsgBox("条件を指定して「検索実行」して比較するためのデータをロードしてください", MsgBoxStyle.Critical, Me.Text)
        End If
    End Sub


